.PHONY: help install build test deploy clean setup check

# é»˜è®¤ç›®æ ‡
help:
	@echo "========================================="
	@echo "ğŸš€ Blueshift Anchor Vault - Makefile"
	@echo "========================================="
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo ""
	@echo "  make setup      - è‡ªåŠ¨è®¾ç½®é¡¹ç›®ï¼ˆæ£€æŸ¥ä¾èµ–ã€å®‰è£…åŒ…ã€æ„å»ºï¼‰"
	@echo "  make install    - å®‰è£… Node.js ä¾èµ–"
	@echo "  make build      - æ„å»ºç¨‹åº"
	@echo "  make test       - è¿è¡Œæµ‹è¯•"
	@echo "  make deploy     - éƒ¨ç½²åˆ°æœ¬åœ°ç½‘ç»œ"
	@echo "  make check      - æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²å®‰è£…"
	@echo "  make clean      - æ¸…ç†æ„å»ºäº§ç‰©"
	@echo ""
	@echo "å¿«é€Ÿå¼€å§‹ï¼š"
	@echo "  make setup      # ç¬¬ä¸€æ¬¡ä½¿ç”¨"
	@echo "  make test       # è¿è¡Œæµ‹è¯•"
	@echo ""
	@echo "========================================="

# æ£€æŸ¥ä¾èµ–
check:
	@echo "ğŸ“‹ æ£€æŸ¥ä¾èµ–..."
	@command -v rustc >/dev/null 2>&1 || { echo "âŒ Rust æœªå®‰è£…"; exit 1; }
	@command -v solana >/dev/null 2>&1 || { echo "âŒ Solana CLI æœªå®‰è£…"; exit 1; }
	@command -v anchor >/dev/null 2>&1 || { echo "âŒ Anchor æœªå®‰è£…"; exit 1; }
	@command -v node >/dev/null 2>&1 || { echo "âŒ Node.js æœªå®‰è£…"; exit 1; }
	@echo "âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…"

# è‡ªåŠ¨è®¾ç½®é¡¹ç›®
setup:
	@echo "ğŸš€ å¼€å§‹è‡ªåŠ¨è®¾ç½®..."
	@./setup.sh

# å®‰è£… Node.js ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£… Node.js ä¾èµ–..."
	@yarn install || npm install
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# æ„å»ºç¨‹åº
build:
	@echo "ğŸ—ï¸  æ„å»ºç¨‹åº..."
	@anchor build
	@echo "âœ… æ„å»ºå®Œæˆ"
	@echo ""
	@echo "æ„å»ºäº§ç‰©ï¼š"
	@ls -lh target/deploy/*.so

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@anchor test
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨å·²è¿è¡Œçš„éªŒè¯å™¨ï¼‰
test-skip-validator:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•ï¼ˆè·³è¿‡å¯åŠ¨éªŒè¯å™¨ï¼‰..."
	@anchor test --skip-local-validator
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# éƒ¨ç½²ç¨‹åº
deploy:
	@echo "ğŸ“¤ éƒ¨ç½²ç¨‹åºåˆ°æœ¬åœ°ç½‘ç»œ..."
	@anchor deploy
	@echo "âœ… éƒ¨ç½²å®Œæˆ"

# éƒ¨ç½²åˆ°ä¸åŒç½‘ç»œï¼ˆä½¿ç”¨è„šæœ¬ï¼‰
deploy-interactive:
	@./deploy.sh

# æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	@anchor clean
	@rm -rf node_modules
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ’… æ ¼å¼åŒ–ä»£ç ..."
	@cargo fmt
	@yarn lint:fix || npm run lint:fix
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆ"

# å¯åŠ¨æœ¬åœ°éªŒè¯å™¨
validator:
	@echo "ğŸ”§ å¯åŠ¨æœ¬åœ°éªŒè¯å™¨..."
	@solana-test-validator

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“ æŸ¥çœ‹ç¨‹åºæ—¥å¿—..."
	@solana logs

# æŸ¥çœ‹é’±åŒ…ä¿¡æ¯
wallet:
	@echo "ğŸ‘› é’±åŒ…ä¿¡æ¯ï¼š"
	@echo "åœ°å€: $$(solana address)"
	@echo "ä½™é¢: $$(solana balance)"
	@echo "ç½‘ç»œ: $$(solana config get | grep 'RPC URL' | awk '{print $$3}')"

# æŸ¥çœ‹ç¨‹åºä¿¡æ¯
info:
	@echo "â„¹ï¸  ç¨‹åºä¿¡æ¯ï¼š"
	@echo "ç¨‹åº ID: 22222222222222222222222222222222222222222222"
	@echo "æ„å»ºäº§ç‰©: target/deploy/blueshift_anchor_vault.so"
	@echo "IDL æ–‡ä»¶: target/idl/blueshift_anchor_vault.json"
	@echo ""
	@if [ -f target/deploy/blueshift_anchor_vault.so ]; then \
		echo "ç¨‹åºæ–‡ä»¶å¤§å°: $$(ls -lh target/deploy/blueshift_anchor_vault.so | awk '{print $$5}')"; \
	else \
		echo "âš ï¸  ç¨‹åºæœªæ„å»ºï¼Œè¿è¡Œ 'make build'"; \
	fi

# å®Œæ•´çš„å¼€å‘æµç¨‹
dev: clean install build test
	@echo "âœ… å¼€å‘æµç¨‹å®Œæˆï¼"

# å¿«é€Ÿé‡å»ºå’Œæµ‹è¯•
quick: build test-skip-validator
	@echo "âœ… å¿«é€Ÿæµ‹è¯•å®Œæˆï¼"
