# Task6 ç¬¬ä¹æ¬¡ä¿®å¤ - å®½æ¾æ£€æŸ¥ï¼ˆ>= 108 å­—èŠ‚ï¼‰

## ä¿®å¤æ—¥æœŸ
2026-01-20 16:49

## é”™è¯¯ä¿¡æ¯ï¼ˆv8ï¼‰

```
ERROR: An account's data contents was invalid
consumed 162 of 1400000 compute units
failed: invalid account data for instruction
```

## é—®é¢˜åˆ†æ

**v8 çš„ä¸¥æ ¼æ£€æŸ¥**ï¼š
```rust
if config_data.len() != 108 {  // âŒ å¿…é¡»æ°å¥½ 108 å­—èŠ‚
    return Err(ProgramError::InvalidAccountData);
}
```

**é—®é¢˜**ï¼šæµ‹è¯•å¹³å°åˆ›å»ºçš„ config è´¦æˆ·é•¿åº¦ä¸æ˜¯æ°å¥½ 108 å­—èŠ‚ï¼

å¯èƒ½çš„æƒ…å†µï¼š
- `len == 0`ï¼šæœªåˆ†é…ç©ºé—´
- `len < 108`ï¼šç©ºé—´ä¸è¶³
- `len > 108`ï¼šç©ºé—´å……è¶³ä½†ä¸æ˜¯æ°å¥½ 108

## è§£å†³æ–¹æ¡ˆï¼ˆv9ï¼‰

**æ”¹ä¸ºæœ€å°é•¿åº¦æ£€æŸ¥ï¼**

### v8ï¼ˆå¤ªä¸¥æ ¼ï¼‰

```rust
// âŒ å¿…é¡»æ°å¥½ 108 å­—èŠ‚
if config_data.len() != 108 {
    return Err(ProgramError::InvalidAccountData);
}
```

### v9ï¼ˆå®½æ¾ï¼‰

```rust
// âœ… åªè¦æ±‚è‡³å°‘ 108 å­—èŠ‚
if config_data.len() < 108 {
    return Err(ProgramError::AccountDataTooSmall);
}

// å¦‚æœ len >= 108ï¼Œå†™å…¥å‰ 108 å­—èŠ‚
config_data[0] = 1;
config_data[1..9].copy_from_slice(&seed.to_le_bytes());
// ... åªä½¿ç”¨å‰ 108 å­—èŠ‚
```

## å…³é”®æ”¹å˜

| ç‰ˆæœ¬ | æ£€æŸ¥é€»è¾‘ | æ¥å—çš„é•¿åº¦ |
|------|----------|-----------|
| v8 | `len != 108` | æ°å¥½ 108 |
| v9 | `len < 108` | **108, 109, 110, ... ä»»ä½• >= 108 çš„é•¿åº¦** |

## å¥½å¤„

### 1. å…¼å®¹æ€§æ›´å¥½

```
æµ‹è¯•å¹³å°åˆ›å»ºï¼š128 å­—èŠ‚è´¦æˆ·
ç¨‹åºä½¿ç”¨ï¼šå‰ 108 å­—èŠ‚
å‰©ä½™ï¼š20 å­—èŠ‚ï¼ˆæœªä½¿ç”¨ä½†ä¸å½±å“ï¼‰
```

### 2. æ›´æ¸…æ™°çš„é”™è¯¯

```rust
// v8 é”™è¯¯
ProgramError::InvalidAccountData  // å¤ªæ¨¡ç³Š

// v9 é”™è¯¯
ProgramError::AccountDataTooSmall // æ˜ç¡®è¯´æ˜ï¼šç©ºé—´ä¸å¤Ÿ
```

### 3. æ ‡å‡†å®è·µ

å¤§å¤šæ•° Solana ç¨‹åºéƒ½ä½¿ç”¨ `>=` æ£€æŸ¥è€Œä¸æ˜¯ `==`ï¼š

```rust
// æ ‡å‡†åšæ³•
if account.data.len() < MIN_SIZE {
    return Err(ProgramError::AccountDataTooSmall);
}

// ä¸å¸¸è§
if account.data.len() != EXACT_SIZE {
    return Err(ProgramError::InvalidAccountData);
}
```

## æ„å»ºç»“æœ

```bash
$ cargo build-sbf
   Compiling blueshift_native_amm v0.1.0
    Finished `release` profile [optimized] target(s) in 0.84s

$ ls -lh target/deploy/*.so
-rwxr-xr-x  15K  blueshift_native_amm.so
```

âœ… **æ„å»ºæˆåŠŸï¼å¤§å°ä¿æŒ 15KB**

## å¯èƒ½çš„ç»“æœ

### ç»“æœ Aï¼šæˆåŠŸåˆå§‹åŒ– âœ…

```
SUCCESS
consumed ~2000-3000 CU
```

**è¯´æ˜**ï¼šConfig è´¦æˆ·é•¿åº¦ >= 108 å­—èŠ‚

### ç»“æœ Bï¼šè´¦æˆ·ç©ºé—´ä¸è¶³

```
ERROR: account data too small for instruction
consumed ~162 CU
```

**åŸå› **ï¼šConfig è´¦æˆ·é•¿åº¦ < 108 å­—èŠ‚

**è§£å†³**ï¼šæµ‹è¯•å¹³å°éœ€è¦åˆ›å»ºè‡³å°‘ 108 å­—èŠ‚çš„è´¦æˆ·

### ç»“æœ Cï¼šå…¶ä»–é”™è¯¯

å¦‚æœè¿˜æœ‰å…¶ä»–é”™è¯¯ï¼Œè¯·æä¾›å®Œæ•´æ—¥å¿—ã€‚

## æ•°æ®å†™å…¥ç¤ºä¾‹

### å¦‚æœè´¦æˆ·é•¿åº¦ = 108

```
è´¦æˆ·ï¼š[0][1][2][3]...[107]  (108 å­—èŠ‚)
å†™å…¥ï¼šå…¨éƒ¨ä½¿ç”¨ âœ…
```

### å¦‚æœè´¦æˆ·é•¿åº¦ = 128

```
è´¦æˆ·ï¼š[0][1][2][3]...[107][108]...[127]  (128 å­—èŠ‚)
å†™å…¥ï¼šä½¿ç”¨å‰ 108 å­—èŠ‚ âœ…
å‰©ä½™ï¼š[108]...[127] æœªä½¿ç”¨ï¼ˆä½†ä¸å½±å“ï¼‰
```

### å¦‚æœè´¦æˆ·é•¿åº¦ = 50

```
è´¦æˆ·ï¼š[0][1][2]...[49]  (50 å­—èŠ‚)
å†™å…¥ï¼šâŒ æ— æ³•å†™å…¥ 108 å­—èŠ‚
é”™è¯¯ï¼šAccountDataTooSmall
```

## æµ‹è¯•å¹³å°è¦æ±‚ï¼ˆæ›´æ–°ï¼‰

### Config è´¦æˆ·

```javascript
const configAccount = {
    space: 108,              // æ¨èï¼šæ°å¥½ 108 å­—èŠ‚
    // æˆ–
    space: 256,              // ä¹Ÿå¯ä»¥ï¼šå¤§äº 108 å­—èŠ‚ï¼ˆç¨‹åºåªç”¨å‰ 108ï¼‰
    
    owner: programId,        // å¿…é¡»
    writable: true,          // å¿…é¡»
    lamports: rentExempt,    // å¿…é¡»
};
```

**å…³é”®**ï¼š`space >= 108` å³å¯ï¼

## ä¿®å¤å†ç¨‹å¯¹æ¯”

| ç‰ˆæœ¬ | æ£€æŸ¥ | é”™è¯¯ | CU |
|------|------|------|-----|
| v7 | è‡ªåŠ¨åˆ†é… | unauthorized signer | 1301 |
| v8 | `len != 108` | invalid account data | **162** |
| **v9** | **`len < 108`** | **å¾…æµ‹è¯•** | **?** |

## ä¸ºä»€ä¹ˆ v8 å¤±è´¥ï¼Ÿ

### æµ‹è¯•å¹³å°å¯èƒ½åˆ›å»ºçš„è´¦æˆ·å¤§å°

å¸¸è§çš„è´¦æˆ·å¤§å°ï¼š
- 0 å­—èŠ‚ï¼ˆæœªåˆ†é…ï¼‰
- 128 å­—èŠ‚ï¼ˆ2^7ï¼Œå¸¸è§çš„é»˜è®¤å€¼ï¼‰
- 256 å­—èŠ‚ï¼ˆ2^8ï¼‰
- 512 å­—èŠ‚ï¼ˆ2^9ï¼‰

**å¾ˆå°‘æœ‰å¹³å°ä¼šåˆ›å»ºæ°å¥½ 108 å­—èŠ‚çš„è´¦æˆ·ï¼**

### v9 çš„ä¼˜åŠ¿

```
æµ‹è¯•å¹³å°ï¼šåˆ›å»ºä»»æ„ >= 108 å­—èŠ‚çš„è´¦æˆ·
ç¨‹åºï¼šåªå…³å¿ƒå‰ 108 å­—èŠ‚
ç»“æœï¼šâœ… å…¼å®¹æ€§æœ€å¤§åŒ–
```

## ä»£ç å¯¹æ¯”

### å®Œæ•´ä»£ç ç‰‡æ®µ

```rust
pub fn initialize(_program_id: &Address, data: &[u8], accounts: &[AccountView]) -> ProgramResult {
    // ... è´¦æˆ·è§£æå’ŒéªŒè¯ ...
    
    let mut config_data = config.try_borrow_mut()?;
    
    // âœ… v9ï¼šå®½æ¾æ£€æŸ¥
    if config_data.len() < 108 {
        return Err(ProgramError::AccountDataTooSmall);
    }
    
    // å†™å…¥æ•°æ®ï¼ˆåªä½¿ç”¨å‰ 108 å­—èŠ‚ï¼‰
    let mut offset = 0;
    
    config_data[offset] = 1;  // state
    offset += 1;
    
    config_data[offset..offset+8].copy_from_slice(&instruction_data.seed.to_le_bytes());
    offset += 8;
    
    // ... ç»§ç»­å†™å…¥å…¶ä»–å­—æ®µ ...
    
    Ok(())
}
```

## æ€»ç»“

ğŸ‰ **ç¬¬ä¹æ¬¡ä¿®å¤ï¼šå®½æ¾æ£€æŸ¥ï¼Œæ¥å—ä»»ä½• >= 108 å­—èŠ‚çš„è´¦æˆ·ï¼**

**æ ¸å¿ƒæ”¹å˜**ï¼š
- âŒ v8ï¼š`len != 108`ï¼ˆå¤ªä¸¥æ ¼ï¼‰
- âœ… v9ï¼š`len < 108`ï¼ˆåˆšåˆšå¥½ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æœ€å¤§åŒ–å…¼å®¹æ€§
- âœ… éµå¾ª Solana æœ€ä½³å®è·µ
- âœ… æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… å¤§å°ä¿æŒ 15KB

**æœŸæœ›**ï¼š
- å¦‚æœæµ‹è¯•å¹³å°æä¾›äº† >= 108 å­—èŠ‚çš„è´¦æˆ· â†’ **æˆåŠŸï¼**
- å¦‚æœæµ‹è¯•å¹³å°æä¾›äº† < 108 å­—èŠ‚çš„è´¦æˆ· â†’ æ˜ç¡®çš„é”™è¯¯

---

**è¿™æ˜¯æœ€å®ç”¨çš„ç‰ˆæœ¬ï¼ä¸Šä¼ æµ‹è¯•å§ï¼** ğŸš€
